<!-- iron-components -->
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<!-- paper-elements -->
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<!-- Trace loader -->
<link rel="import" href="../taaabs-trace-loader/taaabs-trace-loader.html">
<link rel="import" href="../taaabs-trace-timeline-container/taaabs-trace-timeline-container.html">
<link rel="import" href="../taaabs-trace-timeline-stylesheet/taaabs-trace-timeline-stylesheet.html">
<link rel="import" href="../taaabs-trace-timeline-stylesheet/taaabs-tts-editor.html">
<!-- Model view -->
<link rel="import" href="../taaabs-model-simpleview/taaabs-model-simpleview.html">
<!-- Obsel view -->
<link rel="import" href="../taaabs-obsel-simpleview/taaabs-obsel-simpleview.html">
<!-- Style -->
<link rel="import" href="../taaabs-themes/taaabs-theme.html">
<link rel="import" href="../notify-toast-behavior/notify-toast-behavior.html">
<link rel="import" href="../taaabs-time-utilities/taaabs-time-utilities.html">
<!-- Enough with the dependencies -->
<dom-module id="taaabs-trace-timeline-docker">
  <template>
    <style include="taaabs-theme"></style>
    <style>
      :host {
        display: block;
        height: 100%;
        padding: 0px;
      }

      @media screen and (min-width: 1700px) {
        #model-obsel-view-toggler {
          display: none;
        }
        #model-view, #obsel-view {
          width: 50%
        }
        #explorer-view {
          width: 66%;
        }
        #rule-editor-view {
          width: 33%;
        }
      }

      @media screen and (max-width: 1700px) {
        .force-display {
          display: flex;
        }
        .force-hide {
          display: none;
        }
        #model-obsel-view-toggler{
          margin-bottom: 5px;
        }
        .highlighted-toggle {
          border-bottom: solid 1px var(--paper-blue-500);
        }
        #model-view, #obsel-view {
          width: 100%
        }
        #explorer-view {
          width: 50%;
        }
        #rule-editor-view {
          width: 50%;
        }
      }

      @media screen and (max-height: 800px) {
        #explorer-editor-panel {
          height: 250px;
          min-height: 250px;
          max-height: 250px
        }
      }

      @media screen and (min-height: 800px) {
        #explorer-editor-panel {
          height: 400px;
          min-height: 400px;
          max-height: 400px
        }
      }


    </style>
    <iron-pages style="height: 100%" class="flex-vertical" id="pages" selected="0">
      <div id="loading">
        <div>
          <paper-progress id="loading-progress" value="0"></paper-progress>
        </div>
        <div>
          <paper-spinner active></paper-spinner><span>[[_loadingMessage]]</span>
        </div>
      </div>

      <!--

       < ------------------ 1 ------------------ > < --- 2 --- >
      * ----------------------------------------- * ----------- *
      |                                           |             |
      |                    1.1                    |     2.1     |
      |                                           |             |
      |                                           |             |
      * ------------------- * ------------------- *             |
      |        1.2.1        |        1.2.2        |             |
      |                     |                     |             |
      * ------------------- * ------------------- * ----------- *


      -->
      <div id="template-target" class="fit-width flex-horizontal flexchild">
        <!-- 1 -->
        <div class="flexchild fit-height">
          <div class="flex-vertical fit-height">
            <!-- 1.1 -->
            <div class="fit-width flexchild flex-vertical" style="border-bottom: solid 1px grey;">
              <taaabs-trace-timeline-container id="timeline-container" language="en"></taaabs-trace-timeline-container>
            </div>

            <!-- 1.2 -->
            <div id="explorer-editor-panel" class="flex-horizontal">


              <div id="explorer-view" class="flex-vertical flexchild" style="border-right: solid 1px grey">

                <div id="model-obsel-view-toggler" class="flex-horizontal fit-width">
                  <div id="model-view-toggle" class="hoverable clickable" style="width: 50%" on-click="_onModelViewToggle">
                    Model View
                  </div>
                  <div id="obsel-view-toggle" class="hoverable clickable highlighted-toggle" style="width: 50%" on-click="_onObselViewToggle">
                    Obsel View
                  </div>
                </div>
                <div class="flex-horizontal fit-width flexchild">
                  <!-- 1.2.1 -->
                  <div id="model-view" class="swag-scroll force-hide">
                    <taaabs-model-simpleview id="tmsv" model=[[_model]]></taaabs-model-simpleview>
                  </div>

                  <!-- 1.2.2 -->
                  <div id="obsel-view" class="swag-scroll">
                    <taaabs-obsel-simpleview id="tosv" obsel=[[_focusedObsel]]></taaabs-obsel-simpleview>
                  </div>
                </div>
              </div>

              <!-- 1.2.3 -->
              <div id="rule-editor-view" class="swag-scroll" >
                <taaabs-tts-editor id="stylesheet-editor" language="[[language]]"></taaabs-tts-editor>
              </div>
            </div>
          </div>
        </div>
        <!-- 2 -->
        <div class="swag-scroll" style="width: 330px; min-width: 330px; max-width: 330px; border-left: solid 1px grey">
          <taaabs-trace-timeline-stylesheet id="timeline-stylesheet" model=[[_model]] language="[[language]]"></taaabs-trace-timeline-stylesheet>
        </div>
      </div>
    </iron-pages>

    <!-- Taaabs trace loader -->
    <taaabs-trace-loader id="traceLoader" trace-url="[[traceUrl]]" obsels="{{_obsels}}"></taaabs-trace-loader>

    <paper-toast class="fit-bottom" id="__notify_toast__" duration=0> </paper-toast>

  </template>
  <script>
    TAAABS.TraceTimelineDocker = Polymer({
      is: 'taaabs-trace-timeline-docker',

      properties: {
        /**
         * The trace url.
         *
         * @attribute traceUrl
         * @type String
         */
        traceUrl: {
          type: String,
          notify: true,
          value: null
        },

        /**
         * List of obsels dowloaded from the trace.
         *
         * @attribute _obsels
         * @type Array
         */
        _obsels: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * The trace.
         *
         * @attribute _trace
         * @type Object
         */
        _trace: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * The trace stats.
         *
         * @attribute _traceStats
         * @type Object
         */
        _traceStats: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * The model of the trace.
         *
         * @attribute _model
         * @type Object
         */
        _model: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * List of the stylesheets.
         *
         * @attribute _stylesheets
         * @type Array
         */
        _stylesheets: {
          type: Array,
          notify: true,
          value: null
        },

        /**
         * The current stylesheet.
         *
         * @attribute _currentStylesheet
         * @type Object
         */
        _currentStylesheet: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * List of the informations to display in the trace main info panel.
         *
         * @attribute _mainInfoDisplay
         * @type Object
         */
        _mainInfoDisplay: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * Message displayed on loading page.
         *
         * @attribute _loadingMessage
         * @type String
         */
        _loadingMessage: {
          type: String,
          notify: true,
          value: ""
        },

        /** --------------------------------------------------------------------
        // MARK: Properties: Utilities
        **/

        /**
         * Some predefined colors (what a surprise).
         *
         * @attribute _predefined_colors_
         * @type Array
         */
        _predefined_colors_: {
          type: Array,
          value: function() {
            return [
              '#3F51B5', /* Indigo       */
              '#FFEB3B', /* Yellow       */
              '#FF5722', /* Deep Orange  */
              '#4CAF50', /* Green        */
              '#009688', /* Teal         */
              '#9C27B0', /* Purple       */
              '#CDDC39', /* Lime         */
              '#FF9800', /* Orange       */
              '#03A9F4', /* Light Blue   */
              '#E91E63', /* Pink         */
              '#F44336', /* Red          */
              '#607D8B', /* Blue Grey    */
            ];
          }
        },

        /**
         * A taaabs-time-utilities.
         *
         * @attribute _ttu
         * @type Object
         */
        _ttu: {
          type: Object,
          notify: true,
          value: function() {
            return new TAAABS.TimeUtilities();
          }
        },

        language: {
          type: String,
          notify: true,
          value: 'en'
        }
      },

      behaviors: [NotifyToastBehavior],

      ready: function() {},

      attached: function() {

        this.$['timeline-container'].$.timeline.addEventListener('selected-obsel', function(evt){
          var o = this.$['timeline-container'].$.timeline.selectedObsel.obsel;
          this.$.tosv.set('obsel', o);
        }.bind(this));

        this.$['timeline-stylesheet'].addEventListener('timeline-stylesheet-rule-setting', function(evt){
          var r = evt.detail.rule;
          this.$['stylesheet-editor'].setRule(r);
        }.bind(this));

        this.$['stylesheet-editor'].addEventListener('stylesheet-editor-apply', function(evt){
          var r = evt.detail.rule;
          this.$['timeline-stylesheet'].addRule(r);
        }.bind(this));

        this.$['timeline-stylesheet'].addEventListener('stylesheet-changed', function(evt){
          var s = evt.detail.stylesheet;
          this.set('_currentStylesheet', s);
          this.$['timeline-container'].set('stylesheet', s);
          this.$['timeline-container'].updateTimeline();
        }.bind(this));

      },

      clear: function(){
        this.$['timeline-container'].clear();
      },

      refresh: function() {
        this._loadTrace();
      },

      _onModelViewToggle: function(){
        this.$['model-view'].classList.remove('force-hide');
        this.$['obsel-view'].classList.add('force-hide');
        this.$['model-view-toggle'].classList.add('highlighted-toggle');
        this.$['obsel-view-toggle'].classList.remove('highlighted-toggle');
      },

      _onObselViewToggle: function(){
        this.$['obsel-view'].classList.remove('force-hide');
        this.$['model-view'].classList.add('force-hide');
        this.$['obsel-view-toggle'].classList.add('highlighted-toggle');
        this.$['model-view-toggle'].classList.remove('highlighted-toggle');

      },

      /** ----------------------------------------------------------------------
      // MARK: Functions: Loading
      **/

      /**
       * On `TRACE_READY` event from the `trace-loader`. Set the trace and calls `_loadTraceStats`.
       *
       * @param {!required} evt {Event} The `TRACE_READY` event.
       *
       * @method _onTraceReady
       */
      _onTraceReady: function(evt) {
        // Set the `_trace`
        this.set('_trace', this.$.traceLoader.getTrace());

        this.$['timeline-container'].set('trace', this._trace);
        this.$['timeline-container'].set('traceUrl', this._trace.uri);

        // Change the loading status
        this.set('_loadingMessage', 'Loading the trace stats...');
        this.$['loading-progress'].set('value', 20);
        // Load the trace stats
        this._loadTraceStats();
      },

      /**
       * Loads the trace, then calls `_onTraceReady`.
       *
       * @method _loadTrace
       */
      _loadTrace: function() {
        // Set the loading message
        this.set('_loadingMessage', 'Loading the trace...');
        // When the trace is loaded, we load the model of the trace.
        this.$.traceLoader.addEventListener('TRACE_READY', function(evt) {
          console.log(evt);
          evt.preventDefault();
          this._onTraceReady(evt);
        }.bind(this));
        this.$.traceLoader.loadTrace();
      },

      /**
       * On `_trace.get_stats` success. Set `_traceStats`, then calls '_loadModel'.
       *
       * @param {!required} stats {Object} The trace stats.
       *
       * @method _onTraceStatsReady
       */
      _onTraceStatsReady: function(stats) {
        // We set the stats.
        this.set('_traceStats', stats);

        this.$['timeline-container'].set('traceStats', stats);

        // Change the loading status
        this.set('_loadingMessage', 'Loading the trace model...');
        this.$['loading-progress'].set('value', 40);
        // Load the trace stats
        this._loadTraceModel();
      },

      /**
       * Load the trace stats. Calls `_onTraceStatsReady` on loading success.
       *
       * @method _loadTraceStats
       */
      _loadTraceStats: function() {
        this._trace.get_stats().then(function(stats) {
          this._onTraceStatsReady(stats);
        }.bind(this)).catch(function(err) {
          this.notifyToast('An error occured when loading the trace stats. <br/>' + err, {
            'type': 'Error',
            'timeout': -1
          });
        }.bind(this));
      },

      /**
       * On `_model.load()` success. Calls _loadStylesheets.
       *
       * @param {!required}  {String} .
       *
       * @method _onTraceModelReady
       */
      _onTraceModelReady: function() {
        // Change the loading status
        this.set('_loadingMessage', 'Loading stylesheets...');
        this.$['loading-progress'].set('value', 60);
        // Loads the stylesheets
        this._loadStylesheet();
      },

      /**
       * Load the trace model. Calls `_onTraceModelReady` on loading success.
       *
       * @method _loadTraceModel
       */
      _loadTraceModel: function() {
        // Create the Model
        this.set('_model', new Samotraces.Ktbs.Model(this._trace.model_uri));
        //Load the Model
        this._model.load()
          .then(function() {
            this._onTraceModelReady();
          }.bind(this))
          .catch(function(err) {
            console.log(err);
            this.notifyToast('An error occured when loading the trace model. <br/>' + err, {
              'type': 'Error',
              'timeout': -1
            });
          }.bind(this));
      },

      /**
       * Loads the model stylesheets (if they exists), then calls `_loadComponents`.
       *
       * @method _loadStylesheet
       */
      _loadStylesheet: function() {
        if (this._model.model_properties['http://taaabs-hubble/onto#timeline-stylesheet']) {
          var ss = [];
          try {
            ss = JSON.parse(this._model.model_properties['http://taaabs-hubble/onto#timeline-stylesheet']);
          } catch (err) {
            this.notifyToast('An error occured when loading the stored stylesheets. <br/>' + err, {
              'type': 'Warning',
              'timeout': 5000
            });
          }
          this.set('_stylesheets', ss);
        } else {
          this.set('_stylesheets', []);
        }
        // Change the loading status
        this.set('_loadingMessage', 'Loading trace analysis components...');
        this.$['loading-progress'].set('value', 80);
        // Loads the stylesheets
        this._loadComponents();
      },

      /** ----------------------------------------------------------------------
      // MARK: Functions: Components loading
      **/

      /**
       * Loads the differents taaabs components.
       *
       * @method _loadComponents
       */
      _loadComponents() {
        // Set the main informations
        this._displayTraceMainInfo();
        // Create the obsel type stylesheet then load the stylesheet component
        this._createTypeStylesheet();
        this.$['timeline-stylesheet'].refresh();
        this.$['stylesheet-editor'].set('modelUri', this._model.uri);
        // Init the trace histogram component
        this._initTraceTimeline();
        // Init the model simple view
        this.$.tmsv.refresh();
        this.$.pages.set('selected', 1);
      },

      /**
       * Set `_mainInfoDisplay` to display the trace informations.
       *
       * @method _displayTraceMainInfo
       */
      _displayTraceMainInfo() {
        var mid = {};
        var begin_date = new Date(this._traceStats['stats:minTime']);
        var end_date = new Date(this._traceStats['stats:maxTime']);
        mid.minTime = begin_date.toUTCString();
        mid.maxTime = end_date.toUTCString();
        mid.duration = this._ttu.get_human_readable_duration(begin_date, end_date);
        mid.obselCount = this._traceStats['stats:obselCount'];
        mid.traceId = this._trace.attributes['@id'].split('/')[this._trace.attributes['@id'].split('/').length - 2];
        mid.traceLabel = this._trace.attributes.label;
        mid.traceDescription = this._trace.attributes['http://www.w3.org/2000/01/rdf-schema#comment'];
        this.set('_mainInfoDisplay', mid);
      },

      /**
       * Create the default stylesheet, which only focuses on the obsel types.
       *
       * @method _createTypeStylesheet
       */
      _createTypeStylesheet: function() {
        var rules = [];
        var pointer = 0;
        for (var i = 0; i < this._model.list_type_obsels.length; i++) {
          var ssft = this._setSymbolForType(this._model.list_type_obsels[i]['@id'], pointer);
          pointer = ssft.p;
          var rule = {
            id: 'rule for ' + this._uriToName(this._model.list_type_obsels[i]['@id']),
            rules: [{
              type: this._model.list_type_obsels[i]['@id'],
              attributes: []
            }],
            visible: true,
            symbol: ssft.d[1]
          };
          rules.push(rule);
        }
        this.set('_currentStylesheet', {
          'name': 'Obsel_Types',
          'description': 'Stylesheet with one symbol per obsel type.',
          'rules': rules
        });
        this.$['timeline-stylesheet'].set('currentStylesheet', this._currentStylesheet);
      },

      /**
       * Initialise the taaabs-trace-timeline-container.
       *
       * @method _initTraceTimeline
       */
      _initTraceTimeline: function() {
        this.$['timeline-container'].refresh();
        this.$['timeline-container'].set('boundStylesheetComponent', this.$['timeline-stylesheet']);
        this.$['timeline-container'].set('stylesheet', this._currentStylesheet);
      },

      /**
       * Set the taaabs-trace-histogram colors.
       *
       * @method _setTraceHistogramColors
       */
      _setTraceHistogramColors: function(){
        // TODO : bind the colors of the stylehsheet to those of the histogram
        //this.$.tth.setColors()
      },

      /** ----------------------------------------------------------------------
      // MARK: Functions: Utilities
      **/

      _uriToName: function(uri) {
        return (uri) ? uri.replace(this._model.uri + '#', '') : uri;
      },

      _nameToUri: function(name) {
        return this._model.uri + '#' + name;
      },

      _setSymbolForType: function(uri, pointer) {
        if (pointer >= this._predefined_colors_.length) {
          pointer = 0;
        }
        return {
          'd': [uri, {
            'color': this._predefined_colors_[pointer],
            'shape': 'CIRCLE'
          }],
          'p': pointer + 1
        };
      },

      /** ----------------------------------------------------------------------
      // MARK: OLD THINGS
      **/

      /**
       * Loads the trace, the model of the trace, the stylesheet available for the trace.
       *
       * @method giveMeEverything
       */
      giveMeEverything: function() {
        // Update the visu each time an obsels package is downloaded.
        this.$.traceLoader.addEventListener('PACKAGE_LOADED', function(evt) {
          this.$.t3.updateVisu();
        }.bind(this));
        // When the trace is loaded, we load the model of the trace.
        this.$.traceLoader.addEventListener('TRACE_READY', function(evt) {
          this._changeLoadingStatus(0);
          this.set('_trace', this.$.traceLoader.getTrace());
          // TODO finir ici
          this._loadModel();

          //this.$.pages.selected = 1;

          // setTimeout(function() {
          //   this.$.traceLoader.loadObsels();
          //
          //   var begin = this.$.traceLoader.getBeginObsel().begin;
          //   var end = this.$.traceLoader.getEndObsel().end;
          //
          //   this.$.t3.begin = this.$.t3s.begin = begin;
          //   this.$.t3.end = this.$.t3s.end = end;
          //
          //   this.$.t3.initVisu();
          //   this.$.t3s.initVisu();
          //
          //   this.$.t3s.updateVisu(begin, end);
          //   this.$.t3.displayObsels(begin, end, []);
          //
          //   this._bindTimelineEvents();
          //
          // }.bind(this), 500);

        }.bind(this));

        this.$.t3.addEventListener('obselClicked', function(evt) {
          this.set('_focusedObsel', evt.detail.obs);
        }.bind(this));
      },

      _bindTimelineEvents: function() {
        this.$.t3s.addEventListener('zlBeginMoved', function() {
          var begin = this.$.t3s._zlBegin;
          var end = this.$.t3s._zlEnd;
          this.$.t3.displayObsels(begin, end, this._getObselsInRange(begin, end));
          this.$.t3s.updateVisu(begin, end);
        }.bind(this));
        this.$.t3s.addEventListener('zlEndMoved', function() {
          var begin = this.$.t3s._zlBegin;
          var end = this.$.t3s._zlEnd;
          this.$.t3.displayObsels(begin, end, this._getObselsInRange(begin, end));
          this.$.t3s.updateVisu(begin, end);
        }.bind(this));
        this.$.t3s.addEventListener('zlGlobalMoved', function() {
          var begin = this.$.t3s._zlBegin;
          var end = this.$.t3s._zlEnd;
          this.$.t3.displayObsels(begin, end, this._getObselsInRange(begin, end));
          this.$.t3s.updateVisu(begin, end);
        }.bind(this));
        this.$.t3.addEventListener('zoom', function() {
          var begin = this.$.t3._zoomBegin;
          var end = this.$.t3._zoomEnd;
          this.$.t3.displayObsels(begin, end, this._getObselsInRange(begin, end));
          this.$.t3s.updateVisu(begin, end);
        }.bind(this));
      },

      _getObselsInRange: function(begin, end) {
        var obsels = [];
        var i = 0;
        while (i < this._obsels.length && this._obsels[i].begin < begin) {
          i++;
        }
        while (i < this._obsels.length && this._obsels[i].end <= end) {
          obsels.push(this._obsels[i]);
          i++;
        }
        return obsels;
      },

      _initModelSimpleview: function() {
        // Add an event for type or attribute selection
        this.$.tmsv.addSelectionEvent('selected', 'icons:bookmark-border', function(evt, resource) {
          if (resource.obj === 'type')
            this.$.t3se.setType(resource.name.replace('#', "m:"));
          else this.$.t3se.addAttribute(resource.name.replace('#', 'm:'), "");
        }.bind(this));
      }
    });
  </script>
</dom-module>
